import Ember from 'ember';
import ENV from '../config/environment';

// https://github.com/samselikoff/ember-cli-mirage/blob/master/app/initializers/ember-cli-mirage.js
function readSanitizers(prefix) {
    let regex = new RegExp(`^${prefix}/sanitizers/`),
        configs = {};

    // uses a hash `entries` that is tacked onto the requirejs global by ember-resolver 1.0.1
    Object.keys(requirejs.entries).filter(function (key) {
        return regex.test(key);
    }).forEach(function (moduleName) {
        // ignore autogenerated .jshint files
        if (moduleName.match('.jshint')) {
            return;
        }

        let module = require(moduleName, null, null, true),
            moduleSplit = moduleName.split('/'),
            moduleKey = moduleSplit[moduleSplit.length - 1];

        if (!module) {
            throw new Error(`${moduleName} must export a sanitizer`);
        }

        configs[moduleKey] = module.default;
    });

    return configs;
}

export default {
    name: 'ember-cli-sanitize',

    // on app init, take all resolved app sanitizers and add them as configs to the global
    // Sanitize object
    initialize: function (/* registry, application */) {
        Sanitize.Config = Sanitize.Config || {};

        Ember.$.extend(Sanitize.Config, readSanitizers(ENV.modulePrefix));
    }
};
